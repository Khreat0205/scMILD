go_cl
go_cl@result
?gseKEGG
bitr(genes_cl, fromType="SYMBOL", toType="UNIPROT", OrgDb="org.Hs.eg.db")
uniprot_cl = bitr(genes_cl, fromType="SYMBOL", toType="UNIPROT", OrgDb="org.Hs.eg.db")
lfc_cl = cl_markers[,"avg_log2FC"]
genes_cl = rownames(cl_markers)
entrez_cl = bitr(genes_cl, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
uniprot_cl = bitr(genes_cl, fromType="SYMBOL", toType="UNIPROT", OrgDb="org.Hs.eg.db")
entrez_cl$ENTREZID
names(lfc_cl_ent) = entrez_cl$ENTREZID
lfc_cl_ent = lfc_cl
names(lfc_cl_ent) = entrez_cl$ENTREZID
lfc_cl_ent = sort(lfc_cl_ent,decreasing = T)
lfc_cl_uni = lfc_cl
names(lfc_cl_uni) = uniprot_cl$UNIPROT
lfc_cl_uni = sort(lfc_cl_uni,decreasing = T)
lfc_cl_uni
uniprot_cl$UNIPROT
names(lfc_cl_uni) = uniprot_cl$UNIPROT
lfc_cl_uni = sort(lfc_cl_uni,decreasing = T)
lfc_cl_uni
lfc_cl_uni = lfc_cl
lfc_cl
names(lfc_cl_uni)
uniprot_cl$UNIPROT
names(lfc_cl_uni) = uniprot_cl$UNIPROT
uniprot_cl$UNIPROT
gseaplot(go_cl)
gseaplot(go_cl@result)
dotplot(go_cl)
dotplot(go_cl,showCategory=20)
gse_kegg_cl = gseKEGG(lfc_cl,organism = 'hsa',pvalueCutoff = 0.5)
go_cl = gseGO(lfc_cl_ent,OrgDb = "org.Hs.eg.db",keyType = "ENTREZID",pvalueCutoff = 0.5)
gse_kegg_cl = gseKEGG(lfc_cl_ent,organism = 'hsa',pvalueCutoff = 0.5)
dotplot(gse_kegg_cl)
dotplot(gse_kegg_cl,showCategory=20)
dotplot(gse_kegg_cl,showCategory=19)
dotplot(gse_kegg_cl,showCategory=10)
dotplot(gse_kegg_cl,showCategory=15)
dotplot(kegg_cl,showCategory=10)
dotplot(kegg_cl,showCategory=15)
lfc_cl = cl_markers[,"avg_log2FC"]
names(lfc_cl) = entrez_cl$ENTREZID
lfc_cl = sort(lfc_cl,decreasing = T)
lfc_disease = disease_markers[,"avg_log2FC"]
lfc_disease
genes_disease = rownames(disease_markers)
entrez_disease = bitr(genes_disease, fromType="SYMBOL", toType="ENTREZID", OrgDb="org.Hs.eg.db")
names(lfc_disease) = entrez_disease$ENTREZID
lfc_disease = sort(lfc_disease,decreasing = T)
go_disease = gseGO(lfc_disease,OrgDb = "org.Hs.eg.db",keyType = "ENTREZID",pvalueCutoff = 0.5)
gse_kegg_disease = gseKEGG(lfc_disease,organism = 'hsa',pvalueCutoff = 0.5)
dotplot(gse_kegg_disease,showCategory=15)
dotplot(gse_kegg_cl,showCategory=15)
?enrichplot::dotplot()
?enrichplot::dotplot
dotplot(go_disease,showCategory=15)
dotplot(go_cl,showCategory=15)
dotplot(go_cl,showCategory=15, title="Cluster GO:BP") + dotplot(go_disease,showCategory=15,title="Disease GO:BP")
dotplot(gse_kegg_cl,showCategory=15, title="Cluster KEGG") + dotplot(gse_kegg_disease,showCategory=15, title ="Disease KEGG")
# fwrite(sample_meta_only_hosp,file = "PBMC/clustered_sample_meta.csv")
sample_meta_only_hosp= fread(file = "PBMC/clustered_sample_meta.csv")
library(data.table)
# fwrite(sample_meta_only_hosp,file = "PBMC/clustered_sample_meta.csv")
sample_meta_only_hosp= fread(file = "PBMC/clustered_sample_meta.csv")
# AGE, BMI
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", color = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter")+stat_pwc(method="t.test")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
library(ggpubr)
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter")+stat_pwc(method="t.test")
# library(NbClust)
library(ComplexHeatmap)
# AGE, BMI
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", color = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter")+stat_pwc(method="t.test")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
full_meta = fread("UC/covid_19_pbmc_full_meta.csv")
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", color = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter")+stat_pwc(method="t.test")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_cl_age + p_di_age + p_full_age
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", color = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_full_bmi
full_meta$disease_severity_standard = ifelse(full_meta$`Patient Location` == "Hospital", "moderate",ifelse(full_meta$`Patient Location` == "ICU", "severe", "mild"))
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_cl_age + p_di_age + p_full_age
Heatmap(sample_matrix_sm_only_hosp[,-1], split=hcut_res_only_hosp$cluster,right_annotation = ha_only_hosp)
test_obj  = trqwe::mcreadRDS(file = "PBMC/test_seurat.RDS")
sample_meta = unique(test_obj@meta.data[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
sample_dat = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l1) %>%
summarise_at("cell_score_minmax",sum)
sample_dat_l2 = sample_dat_l2 %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_minmax / sum(cell_score_minmax)) %>% ungroup()
sample_matrix = dcast(sample_dat,formula = sample ~predicted.celltype.l1,fill = 0,value.var = "cell_type_ratio")
sample_table = merge(sample_matrix,sample_meta,by="sample")
library(dplyr)
library(tidyr)
sample_meta
sample_dat = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l1) %>%
summarise_at("cell_score_minmax",sum)
sample_dat = sample_dat %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_minmax / sum(cell_score_minmax)) %>% ungroup()
sample_dat_l2 = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l2) %>%
summarise_at("cell_score_minmax",sum)
sample_dat_l2 = sample_dat_l2 %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_minmax / sum(cell_score_minmax)) %>% ungroup()
sample_dat = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l1) %>%
summarise_at("cell_score_minmax",sum)
test_obj@meta.data
test_obj@meta.data$cell_score_minmax = test_obj@meta.data$cell_score_teacher_minmax
# test_obj@meta.data$cell_score_minmax = test_obj@meta.data$cell_score_teacher_minmax
sample_dat = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l1) %>%
summarise_at("cell_score_minmax",sum)
sample_dat = sample_dat %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_minmax / sum(cell_score_minmax)) %>% ungroup()
sample_dat_l2 = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l2) %>%
summarise_at("cell_score_minmax",sum)
sample_dat_l2 = sample_dat_l2 %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_minmax / sum(cell_score_minmax)) %>% ungroup()
sample_matrix = dcast(sample_dat,formula = sample ~predicted.celltype.l1,fill = 0,value.var = "cell_type_ratio")
sample_matrix_l2 = dcast(sample_dat_l2,formula = sample ~predicted.celltype.l2,fill = 0,value.var = "cell_type_ratio")
sample_matrix = merge(sample_matrix, sample_matrix_l2,by="sample",suffixes =c(".l1",".l2"))
rownames(sample_matrix) = sample_matrix$sample
sample_table = merge(sample_matrix,sample_meta,by="sample")
Heatmap(sample_matrix[,-1],row_order = order(sample_meta$days_since_symptom_onset_standard))
softmax = function(x) exp(x)/sum(exp(x))
softmax_within_sample_id = function(obj){
cell_score = obj$cell_score # this is vector
sample_id = obj$sample_id_numeric
sample_id_unique = unique(sample_id)
softmax_scores = rep(0,length(cell_score))
for (i in 1:length(sample_id_unique)){
sample_id_i = sample_id_unique[i]
cell_score_i = cell_score[sample_id == sample_id_i]
softmax_scores[sample_id == sample_id_i] = softmax(cell_score_i)
}
return(softmax_scores)
}
sm_scores = softmax_within_sample_id(test_obj)
test_obj@meta.data$cell_score_softmax = sm_scores
test_obj@meta.data$cell_score_teacher
# test_obj@meta.data$cell_score_minmax = test_obj@meta.data$cell_score_teacher_minmax
test_obj@meta.data$cell_score = test_obj@meta.data$cell_score_teacher
softmax_within_sample_id = function(obj){
cell_score = obj$cell_score # this is vector
sample_id = obj$sample_id_numeric
sample_id_unique = unique(sample_id)
softmax_scores = rep(0,length(cell_score))
for (i in 1:length(sample_id_unique)){
sample_id_i = sample_id_unique[i]
cell_score_i = cell_score[sample_id == sample_id_i]
softmax_scores[sample_id == sample_id_i] = softmax(cell_score_i)
}
return(softmax_scores)
}
sm_scores = softmax_within_sample_id(test_obj)
test_obj@meta.data$cell_score_softmax = sm_scores
sample_dat_l2_sm = test_obj@meta.data %>%
group_by(sample,predicted.celltype.l2) %>%
summarise_at("cell_score_softmax",sum)
sample_dat_l2_sm = sample_dat_l2_sm %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_softmax / sum(cell_score_softmax)) %>% ungroup()
sample_dat_l2_sm
sample_matrix_l2_sm = dcast(sample_dat_l2_sm,formula = sample ~predicted.celltype.l2,fill = 0,value.var = "cell_type_ratio")
sample_meta = sample_meta[match(sample_matrix_l2_sm[,1],sample_meta$sample),]
Heatmap(sample_matrix_l2_sm[,-1],split=sample_meta$disease_severity_standard,clustering_method_rows = 'centroid')
Heatmap(sample_matrix_l2_sm[,-1][,colMeans(sample_matrix_l2_sm[,-1]) > 0.01],split=sample_meta$disease_severity_standard,)
Heatmap(sample_matrix_l2_sm[,-1][,colMeans(sample_matrix_l2_sm[,-1]) > 0.01],split=sample_meta$sex_standard,)
Heatmap(sample_matrix_l2_sm[,-1][,colMeans(sample_matrix_l2_sm[,-1]) > 0.01],split=sample_meta$days_since_symptom_onset_standard,)
ha = rowAnnotation(
severity = sample_meta$disease_severity_standard,
age = sample_meta$age_standard,
days = sample_meta$days_since_symptom_onset_standard,
sex = sample_meta$sex_standard,
col = list(severity = c("mild" = "blue", "moderate" = "orange", "severe" = "red"),
# age is integer value, gradient color
age = colorRamp2(c(min(sample_meta$age_standard), max(sample_meta$age_standard)), c("white", "red")),
# days is categorical value ( 7 or 14)
days = c("7" = "red", "14" = "orange"),
# sex is categorical value ( female or male)
sex = c(female = "pink", male = "navy")
)
)
Heatmap(sample_matrix_l2_sm[,-1][,colMeans(sample_matrix_l2_sm[,-1]) > 0.01], right_annotation = ha, row_km_repeats=10, row_km = 5)
fviz_nbclust(sample_matrix_sm_only_hosp[,-1], hcut, method = "silhouette",hc_method="complete",k.max = 5)
library(factoextra)
fviz_nbclust(sample_matrix_sm_only_hosp[,-1], hcut, method = "silhouette",hc_method="complete",k.max = 5)
sample_matrix_sm_only_hosp= sample_matrix_l2_sm[sample_meta$disease == "Hosp",]
fviz_nbclust(sample_matrix_sm_only_hosp[,-1], hcut, method = "silhouette",hc_method="complete",k.max = 5)
fviz_nbclust(sample_matrix_sm_only_hosp[,-1], kmeans, method = "silhouette",k.max = 6)
hcut_res_only_hosp = hcut(sample_matrix_sm_only_hosp[,-1], k = 2, hc_method = "complete", hc_metric = "euclidean")
Heatmap(sample_matrix_l2_sm[,-1], right_annotation = ha, split=hcut_res$cluster)
sample_matrix_l2_sm
sample_meta_only_hosp = sample_meta[sample_meta$disease == "Hosp",]
sample_meta_only_hosp$cluster = hcut_res_only_hosp$cluster
ha_only_hosp = rowAnnotation(
severity = sample_meta_only_hosp$disease_severity_standard,
age = sample_meta_only_hosp$age_standard,
days = sample_meta_only_hosp$days_since_symptom_onset_standard,
sex = sample_meta_only_hosp$sex_standard,
col = list(severity = c("mild" = "blue", "moderate" = "white", "severe" = "red"),
# age is integer value, gradient color
age = colorRamp2(c(min(sample_meta_only_hosp$age_standard)*1.2, max(sample_meta_only_hosp$age_standard)*0.8), c("white", "red")),
# days is categorical value ( 7 or 14)
days = c("7" = "red", "14" = "orange"),
# sex is categorical value ( female or male)
sex = c(female = "pink", male = "navy")
)
)
Heatmap(sample_matrix_sm_only_hosp[,-1], split=hcut_res_only_hosp$cluster,right_annotation = ha_only_hosp)
ha_only_hosp = rowAnnotation(
severity = sample_meta_only_hosp$disease_severity_standard,
age = sample_meta_only_hosp$age_standard,
days = sample_meta_only_hosp$days_since_symptom_onset_standard,
sex = sample_meta_only_hosp$sex_standard,
col = list(severity = c("mild" = "blue", "moderate" = "white", "severe" = "red"),
# age is integer value, gradient color
age = colorRamp2(c(min(sample_meta_only_hosp$age_standard)*1.2, max(sample_meta_only_hosp$age_standard)*0.8), c("white", "red")),
# days is categorical value ( 7 or 14)
days = c("7" = "red", "14" = "orange"),
# sex is categorical value ( female or male)
sex = c(female = "pink", male = "navy")
)
)
library(circlize)
ha = rowAnnotation(
severity = sample_meta$disease_severity_standard,
age = sample_meta$age_standard,
days = sample_meta$days_since_symptom_onset_standard,
sex = sample_meta$sex_standard,
col = list(severity = c("mild" = "blue", "moderate" = "orange", "severe" = "red"),
# age is integer value, gradient color
age = colorRamp2(c(min(sample_meta$age_standard), max(sample_meta$age_standard)), c("white", "red")),
# days is categorical value ( 7 or 14)
days = c("7" = "red", "14" = "orange"),
# sex is categorical value ( female or male)
sex = c(female = "pink", male = "navy")
)
)
hcut_res_only_hosp = hcut(sample_matrix_sm_only_hosp[,-1], k = 2, hc_method = "complete", hc_metric = "euclidean")
sample_meta_only_hosp = sample_meta[sample_meta$disease == "Hosp",]
sample_meta_only_hosp$cluster = hcut_res_only_hosp$cluster
ha_only_hosp = rowAnnotation(
severity = sample_meta_only_hosp$disease_severity_standard,
age = sample_meta_only_hosp$age_standard,
days = sample_meta_only_hosp$days_since_symptom_onset_standard,
sex = sample_meta_only_hosp$sex_standard,
col = list(severity = c("mild" = "blue", "moderate" = "white", "severe" = "red"),
# age is integer value, gradient color
age = colorRamp2(c(min(sample_meta_only_hosp$age_standard)*1.2, max(sample_meta_only_hosp$age_standard)*0.8), c("white", "red")),
# days is categorical value ( 7 or 14)
days = c("7" = "red", "14" = "orange"),
# sex is categorical value ( female or male)
sex = c(female = "pink", male = "navy")
)
)
Heatmap(sample_matrix_sm_only_hosp[,-1], split=hcut_res_only_hosp$cluster,right_annotation = ha_only_hosp)
sample_meta = merge(sample_meta, full_meta, by="sample",all.x=T, all.y=F)
sample_meta_only_hosp = merge(sample_meta_only_hosp, full_meta, by="sample",all.x=T, all.y=F)
sample_meta_only_hosp$cluster = as.factor(sample_meta_only_hosp$cluster)
# fwrite(sample_meta_only_hosp,file = "PBMC/clustered_sample_meta.csv")
sample_meta_only_hosp= fread(file = "PBMC/clustered_sample_meta.csv")
sample_meta_only_hosp$cluster == hcut_res_only_hosp
sample_meta_only_hosp$cluster == hcut_res_only_hosp$data
sample_meta_only_hosp$cluster == hcut_res_only_hosp$cluster
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", color = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter")+stat_pwc(method="t.test")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method =
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter")+ stat_pwc(method = "t.test")
p_cl_age + p_di_age + p_full_age
# AGE, BMI
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
library(RColorBrewer)
# AGE, BMI
brewer.pal(2,"Set1")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set1") )+stat_pwc(method="t.test")
p_di_age
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2") )+stat_pwc(method="t.test")
p_di_age
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")
p_cl_age + p_di_age + p_full_age
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test") +theme(legend.position = "none")
p_cl_age + p_di_age + p_full_age
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method="t.test")+
theme(legend.position = "none")
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")
p_cl_age + p_di_age + p_full_age
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method = "t.test") +
theme(legend.position = "none")+xlab("Severity")
p_cl_age + p_di_age + p_full_age
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method="t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method = "t.test") +
theme(legend.position = "none")+xlab("Whole Dataset")
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+xlab("Test Dataset")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+xlab("Test Dataset")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+xlab("Whole Dataset")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Whole Dataset")
p_cl_age + p_di_age + p_full_age
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Whole Dataset")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_cl_age = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
p_di_age = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "age_standard", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method="t.test")+
theme(legend.position = "none")+xlab("Test Dataset")+ylab("")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "Age", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method = "t.test") +
theme(legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_age + p_di_age + p_full_age
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")+ylab("")
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")],
x = "disease_severity_standard", y = "BMI", fill = "disease_severity_standard",
add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(axis.text.x = c("Hospital","ICU"),legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_bmi + p_di_bmi+ p_full_bmi
?ggboxplot
p_full_bmi = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")],
x = "Patient Location", y = "BMI", fill = "disease_severity_standard",
add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_bmi + p_di_bmi+ p_full_bmi
p_di_bmi = ggboxplot(sample_meta_only_hosp, x = "Patient Location", y = "BMI", fill = "Patient Location", add = "jitter", palette =brewer.pal(2,"Set2"))+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")+ylab("")
p_di_bmi
p_di_age = ggboxplot(sample_meta_only_hosp, x = "Patient Location", y = "age_standard", fill = "Patient Location", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method="t.test")+
theme(legend.position = "none")+xlab("Test Dataset")+ylab("")
p_full_age = ggboxplot(full_meta[full_meta$disease_severity_standard %in% c("moderate","severe")], x = "Patient Location", y = "Age", fill = "Patient Location", add = "jitter", palette =brewer.pal(2,"Set2"))+
stat_pwc(method = "t.test") +
theme(legend.position = "none")+xlab("Whole Dataset")+ylab("")
p_cl_age + p_di_age + p_full_age
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test",p.adjust.method = "none")+
theme(legend.position = "none")+xlab("Test Dataset")
p_cl_bmi
?stat_pwc
p_cl_bmi = ggboxplot(sample_meta_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t_test")+
theme(legend.position = "none")+xlab("Test Dataset")
p_cl_bmi
?stat_compare_means
fisher.test(table(sample_meta_only_hosp$cluster,ifelse(sample_meta_only_hosp$BMI >= 30,"obesity", "no")))
fisher.test(table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$disease_severity_standard)[,2:3])
table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$disease_severity_standard)[,2:3]
table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$disease_severity_standard)
fisher.test(table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$disease_severity_standard))
fisher.test(table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$Asthma))
fisher.test(table(sample_meta_only_hosp$disease_severity_standard, sample_meta_only_hosp$Asthma))
table(sample_meta_only_hosp$disease_severity_standard, sample_meta_only_hosp$Asthma)
fisher.test(table(sample_meta_only_hosp$disease_severity_standard, sample_meta_only_hosp$Asthma))
fisher.test(table(sample_meta_only_hosp$cluster, sample_meta_only_hosp$Asthma))
fisher.test(table(full_meta$disease_severity_standard, full_meta$Asthma)[2:3,])
table(full_meta$disease_severity_standard, full_meta$Asthma)[2:3,]
fisher.test(table(sample_meta_only_hosp$cluster,sample_meta_only_hosp$`Coronary Artery Disease`))
fisher.test(table(sample_meta_only_hosp$cluster,sample_meta_only_hosp$`Cigarette Smoking`)[,1:2]) ###
fisher.test(table(full_meta$disease_severity_standard, full_meta$`Cigarette Smoking`)[2:3,])
table(sample_meta_only_hosp$cluster,sample_meta_only_hosp$`Respiratory Support`)
fisher.test(table(sample_meta_only_hosp$cluster,sample_meta_only_hosp$Ethnicity))
table(sample_meta_only_hosp$cluster,sample_meta_only_hosp$Ethnicity)
fread("Lupus/cell_score_1.csv")
fread("PBMC/cell_score_1.csv")
cs_exp3= fread("PBMC/cell_score_3.csv")
cs_exp3
obs_exp3 = fread("PBMC/obs_3.csv")
obs_exp3
obs_exp3$predicted.celltype.l1 == cs_exp3$cell_type
mat_exp3 = cbind(obs_exp3, cs_exp3)
mat_exp3
softmax_within_sample_id_mat = function(mat){
cell_score = mat$cell_score
sample_id = obj$sample_id_numeric
sample_id_unique = unique(sample_id)
softmax_scores = rep(0,length(cell_score))
for (i in 1:length(sample_id_unique)){
sample_id_i = sample_id_unique[i]
cell_score_i = cell_score[sample_id == sample_id_i]
softmax_scores[sample_id == sample_id_i] = softmax(cell_score_i)
}
return(softmax_scores)
}
softmax_within_sample_id_mat(mat_exp3)
softmax_within_sample_id_mat = function(mat){
cell_score = mat$cell_score
sample_id = mat$sample_id_numeric
sample_id_unique = unique(sample_id)
softmax_scores = rep(0,length(cell_score))
for (i in 1:length(sample_id_unique)){
sample_id_i = sample_id_unique[i]
cell_score_i = cell_score[sample_id == sample_id_i]
softmax_scores[sample_id == sample_id_i] = softmax(cell_score_i)
}
return(softmax_scores)
}
softmax_within_sample_id_mat(mat_exp3)
mat_exp3$cell_score_softmax = softmax_within_sample_id_mat(mat_exp3)
mat_exp3_l2_sm = mat_exp3%>% (sample,predicted.celltype.l2) %>%
mat_exp3_l2_sm = mat_exp3_l2_sm %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_softmax / sum(cell_score_softmax)) %>% ungroup()
mat_exp3_matrix_l2_sm = dcast(mat_exp3_l2_sm ,formula = sample ~predicted.celltype.l2,fill = 0,value.var = "cell_type_ratio")
mat_exp3_l2_sm = mat_exp3 %>% (sample,predicted.celltype.l2) %>%
mat_exp3_l2_sm = mat_exp3 %>% group_by(sample, predicted.celltype.l2) %>%
summarise_at("cell_score_softmax",sum)
mat_exp3_l2_sm = mat_exp3_l2_sm %>% group_by(sample) %>%
mutate(cell_type_ratio = cell_score_softmax / sum(cell_score_softmax)) %>% ungroup()
mat_exp3_matrix_l2_sm = dcast(mat_exp3_l2_sm ,formula = sample ~predicted.celltype.l2,fill = 0,value.var = "cell_type_ratio")
mat_exp3_matrix_l2_sm
mat_exp3_matrix_l2_sm
Heatmap(mat_exp3_matrix_l2_sm[,-1])
Heatmap(mat_exp3_matrix_l2_sm[,-1],km=2)
rm(obs_exp3,cs_exp3)
mat_exp3_matrix_l2_sm
full_meta$sample
full_meta$disease_severity_standard
full_meta$disease_severity_standard %in% c("moderate","severe")
full_meta$sample[full_meta$disease_severity_standard %in% c("moderate","severe")]
mat_exp3_matrix_l2_sm$sample %in% full_meta$sample[full_meta$disease_severity_standard %in% c("moderate","severe")]
mat_exp3_matrix_l2_sm[mat_exp3_matrix_l2_sm$sample %in% full_meta$sample[full_meta$disease_severity_standard %in% c("moderate","severe")],]
exp3_matrix_only_hosp =mat_exp3_matrix_l2_sm[mat_exp3_matrix_l2_sm$sample %in% full_meta$sample[full_meta$disease_severity_standard %in% c("moderate","severe")],]
Heatmap(exp3_matrix_only_hosp[,-1],km=2)
hcut_res_only_hosp_exp3 = hcut(exp3_matrix_only_hosp[,-1], k = 2, hc_method = "complete", hc_metric = "euclidean")
Heatmap(exp3_matrix_only_hosp[,-1],split=hcut_res_only_hosp_exp3$cluster)
obs_exp3 = fread("PBMC/obs_3.csv")
sample_meta_exp3 = merge(obs_exp3, full_meta, by="sample",all.x=T, all.y=F)
sample_meta_exp3
sample_meta_exp3
sample_meta_exp3[sample_meta_exp3$disease_severity_standard %in% c("moderate","severe"),]
sample_meta_exp3$disease_severity_standard
sample_meta_exp3
?merge
sample_meta_exp3 = merge(obs_exp3, full_meta, by="sample",all.x=T, all.y=F,suffixes = c("",".y"))
sample_meta_exp3_only_hosp = sample_meta_exp3[sample_meta_exp3$disease_severity_standard %in% c("moderate","severe"),]
sample_meta_exp3_only_hosp
exp3_matrix_only_hosp
exp3_matrix_only_hosp[,1]
exp3_matrix_only_hosp[,1] == sample_meta_exp3_only_hosp[,1]
sample_meta_exp3 = unique(obs_exp3[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
sample_meta_exp3
sample_meta_exp3
sample_meta_exp3 = unique(obs_exp3[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
sample_meta_exp3
sample_meta_exp3 = unique(obs_exp3[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
unique(obs_exp3[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
obs_exp3
obs_exp3[,c("sample","disease","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")]
sample_meta_exp3 = unique(obs_exp3[,c("sample","age_standard","sex_standard","disease_severity_standard","days_since_symptom_onset_standard")])
sample_meta_exp3
sample_meta_exp3 = merge(sample_meta_exp3, full_meta, by="sample",all.x=T, all.y=F,suffixes = c("",".y"))
sample_meta_exp3_only_hosp = sample_meta_exp3[sample_meta_exp3$disease_severity_standard %in% c("moderate","severe"),]
sample_meta_exp3_only_hosp
sample_meta_exp3_only_hosp[,1] == exp3_matrix_only_hosp[.1]
sample_meta_exp3_only_hosp[,1] == exp3_matrix_only_hosp[,1]
sample_meta_exp3_only_hosp
sample_meta_exp3_only_hosp$cluster = as.factor(hcust_res_only_hosp_exp3$cluster)
p_cl_age = ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
p_cl_age
sample_meta_exp3_only_hosp
sample_meta_exp3_only_hosp$age_standard
p_cl_age = ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
sample_meta_exp3_only_hosp$age_standard
sample_meta_exp3_only_hosp$cluster
as.factor(hcust_res_only_hosp_exp3$cluster)
hcust_res_only_hosp_exp3$cluster
sample_meta_exp3_only_hosp$cluster = as.factor(hcut_res_only_hosp_exp3$cluster)
sample_meta_exp3_only_hosp$cluster
ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
Heatmap(exp3_matrix_only_hosp[,-1],split=hcut_res_only_hosp_exp3$cluster)
ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "age_standard", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+theme(legend.position = "none")+xlab("Test Dataset")
Heatmap(exp3_matrix_only_hosp[,-1],split=hcut_res_only_hosp_exp3$cluster)
ggboxplot(sample_meta_exp3_only_hosp, x = "cluster", y = "BMI", fill = "cluster", add = "jitter")+ stat_pwc(method = "t.test")+
theme(legend.position = "none")+xlab("Test Dataset")
Heatmap(exp3_matrix_only_hosp[,-1],split=hcut_res_only_hosp_exp3$cluster)
gc()
